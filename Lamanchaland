-- LocalScript (place inside a ScreenGui in StarterGui)
-- Improved draggable version with better UX, progress feedback & safety checks

local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")

local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui", 10)

local character = player.Character or player.CharacterAdded:Wait()
local buildingTools = character:WaitForChild("Building Tools", 8)

if not buildingTools then
	warn("Building Tools not found in character")
	return
end

local syncAPI = buildingTools:WaitForChild("SyncAPI", 5)
local serverEndpoint = syncAPI:WaitForChild("ServerEndpoint", 5)

-- ────────────────────────────────────────────────
--  GUI Setup
-- ────────────────────────────────────────────────

local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "PartGrouperPro"
ScreenGui.ResetOnSpawn = false
ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
ScreenGui.Parent = playerGui

local MainFrame = Instance.new("Frame")
MainFrame.Name = "Main"
MainFrame.Size = UDim2.new(0, 340, 0, 210)
MainFrame.Position = UDim2.new(0.5, -170, 0.5, -105)
MainFrame.BackgroundColor3 = Color3.fromRGB(32, 32, 38)
MainFrame.BorderSizePixel = 0
MainFrame.ClipsDescendants = true
MainFrame.Parent = ScreenGui

local UICorner = Instance.new("UICorner")
UICorner.CornerRadius = UDim.new(0, 10)
UICorner.Parent = MainFrame

local UIGradient = Instance.new("UIGradient")
UIGradient.Color = ColorSequence.new{
	ColorSequenceKeypoint.new(0, Color3.fromRGB(45,45,55)),
	ColorSequenceKeypoint.new(1, Color3.fromRGB(25,25,32))
}
UIGradient.Rotation = 90
UIGradient.Parent = MainFrame

-- Title bar (draggable area)
local TitleBar = Instance.new("Frame")
TitleBar.Name = "TitleBar"
TitleBar.Size = UDim2.new(1, 0, 0, 42)
TitleBar.BackgroundColor3 = Color3.fromRGB(24, 24, 32)
TitleBar.BorderSizePixel = 0
TitleBar.Parent = MainFrame

local TitleLabel = Instance.new("TextLabel")
TitleLabel.Size = UDim2.new(1, -90, 1, 0)
TitleLabel.Position = UDim2.new(0, 14, 0, 0)
TitleLabel.BackgroundTransparency = 1
TitleLabel.Font = Enum.Font.GothamBold
TitleLabel.Text = "Part Grouper Pro"
TitleLabel.TextColor3 = Color3.fromRGB(235, 235, 245)
TitleLabel.TextSize = 18
TitleLabel.TextXAlignment = Enum.TextXAlignment.Left
TitleLabel.Parent = TitleBar

local CloseButton = Instance.new("TextButton")
CloseButton.Size = UDim2.new(0, 32, 0, 32)
CloseButton.Position = UDim2.new(1, -38, 0, 5)
CloseButton.BackgroundColor3 = Color3.fromRGB(215, 70, 70)
CloseButton.Text = "×"
CloseButton.TextColor3 = Color3.new(1,1,1)
CloseButton.Font = Enum.Font.GothamBold
CloseButton.TextSize = 22
CloseButton.Parent = TitleBar

local CloseCorner = Instance.new("UICorner")
CloseCorner.CornerRadius = UDim.new(0, 8)
CloseCorner.Parent = CloseButton

-- Content area
local Content = Instance.new("Frame")
Content.Name = "Content"
Content.Size = UDim2.new(1, 0, 1, -42)
Content.Position = UDim2.new(0, 0, 0, 42)
Content.BackgroundTransparency = 1
Content.Parent = MainFrame

local Label = Instance.new("TextLabel")
Label.Size = UDim2.new(1, -24, 0, 22)
Label.Position = UDim2.new(0, 12, 0, 18)
Label.BackgroundTransparency = 1
Label.Text = "Max parts per folder (4000–15000 recommended):"
Label.TextColor3 = Color3.fromRGB(190, 190, 210)
Label.TextSize = 14
Label.Font = Enum.Font.Gotham
Label.TextXAlignment = Enum.TextXAlignment.Left
Label.Parent = Content

local InputBox = Instance.new("TextBox")
InputBox.Size = UDim2.new(1, -24, 0, 42)
InputBox.Position = UDim2.new(0, 12, 0, 44)
InputBox.BackgroundColor3 = Color3.fromRGB(25, 25, 32)
InputBox.BorderSizePixel = 0
InputBox.TextColor3 = Color3.new(1,1,1)
InputBox.PlaceholderText = "e.g. 8000"
InputBox.Text = "8000"
InputBox.TextSize = 18
InputBox.Font = Enum.Font.GothamSemibold
InputBox.ClearTextOnFocus = false
InputBox.Parent = Content

local InputCorner = Instance.new("UICorner")
InputCorner.CornerRadius = UDim.new(0, 8)
InputCorner.Parent = InputBox

local StatusLabel = Instance.new("TextLabel")
StatusLabel.Size = UDim2.new(1, -24, 0, 54)
StatusLabel.Position = UDim2.new(0, 12, 0, 94)
StatusLabel.BackgroundTransparency = 1
StatusLabel.Text = ""
StatusLabel.TextColor3 = Color3.fromRGB(170, 170, 190)
StatusLabel.TextSize = 14
StatusLabel.TextWrapped = true
StatusLabel.TextXAlignment = Enum.TextXAlignment.Left
StatusLabel.TextYAlignment = Enum.TextYAlignment.Top
StatusLabel.Parent = Content

local StartButton = Instance.new("TextButton")
StartButton.Size = UDim2.new(0, 140, 0, 44)
StartButton.Position = UDim2.new(0.5, -70, 1, -62)
StartButton.BackgroundColor3 = Color3.fromRGB(0, 122, 255)
StartButton.TextColor3 = Color3.new(1,1,1)
StartButton.Font = Enum.Font.GothamSemibold
StartButton.TextSize = 17
StartButton.Text = "Group Parts"
StartButton.Parent = Content

local BtnCorner = Instance.new("UICorner")
BtnCorner.CornerRadius = UDim.new(0, 10)
BtnCorner.Parent = StartButton

-- ────────────────────────────────────────────────
--  Draggable logic
-- ────────────────────────────────────────────────

local dragging, dragStart, startPos

TitleBar.InputBegan:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
		dragging = true
		dragStart = input.Position
		startPos = MainFrame.Position
		
		input.Changed:Connect(function()
			if input.UserInputState == Enum.UserInputState.End then
				dragging = false
			end
		end)
	end
end)

UserInputService.InputChanged:Connect(function(input)
	if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
		local delta = input.Position - dragStart
		MainFrame.Position = UDim2.new(
			startPos.X.Scale,
			startPos.X.Offset + delta.X,
			startPos.Y.Scale,
			startPos.Y.Offset + delta.Y
		)
	end
end)

-- Close button
CloseButton.MouseButton1Click:Connect(function()
	ScreenGui:Destroy()
end)

-- ────────────────────────────────────────────────
--  Core logic
-- ────────────────────────────────────────────────

local function isValidPart(part)
	if not part:IsA("BasePart") then return false end
	if part == workspace.Terrain or part:IsDescendantOf(workspace.Terrain) then return false end
	if part:IsDescendantOf(character) then return false end
	
	local p = part.Parent
	while p and p ~= workspace do
		if p:IsA("Tool") or p:IsA("Accessory") or p:IsA("Hat") then
			return false
		end
		p = p.Parent
	end
	
	return true
end

local function collectParts()
	local parts = {}
	for _, obj in workspace:GetDescendants() do   -- deeper search
		if isValidPart(obj) then
			table.insert(parts, obj)
		end
	end
	return parts
end

local function setStatus(text, color)
	StatusLabel.Text = text
	StatusLabel.TextColor3 = color or Color3.fromRGB(170,170,190)
end

local function disableUI()
	StartButton.Active = false
	StartButton.BackgroundColor3 = Color3.fromRGB(70, 70, 85)
	StartButton.Text = "Processing..."
	InputBox.Active = false
end

local function enableUI()
	StartButton.Active = true
	StartButton.BackgroundColor3 = Color3.fromRGB(0, 122, 255)
	StartButton.Text = "Group Parts"
	InputBox.Active = true
end

StartButton.MouseButton1Click:Connect(function()
	local input = InputBox.Text:gsub("%s+", "")
	local maxParts = tonumber(input)

	if not maxParts or maxParts < 500 or maxParts > 60000 then
		setStatus("Please enter a number between 500 and 60000.", Color3.fromRGB(255, 90, 90))
		return
	end

	disableUI()
	setStatus("Scanning workspace for parts...", Color3.fromRGB(255, 215, 0))

	task.wait(0.1)

	local allParts = collectParts()
	local total = #allParts

	if total == 0 then
		setStatus("No valid parts found in workspace.", Color3.fromRGB(255, 140, 140))
		enableUI()
		return
	end

	setStatus(("Found %d parts. Creating folders..."):format(total), Color3.fromRGB(220, 220, 140))

	local groups = {}
	local current = {}
	local count = 0

	for _, part in allParts do
		table.insert(current, part)
		count += 1
		
		if count >= maxParts then
			table.insert(groups, current)
			current = {}
			count = 0
		end
	end

	if #current > 0 then
		table.insert(groups, current)
	end

	local successCount = 0

	for i, group in ipairs(groups) do
		local args = {
			"CreateGroup" .. i,
			"Folder",
			workspace,
			group
		}

		local ok, err = pcall(function()
			serverEndpoint:InvokeServer(unpack(args))
		end)

		if ok then
			successCount += 1
		else
			warn("Group " .. i .. " failed: " .. tostring(err))
		end

		task.wait(0.12 + math.random(1,40)/100)  -- slight jitter to avoid rate-limit patterns
	end

	setStatus(
		("Completed!\nCreated %d folder(s) • %d parts total"):format(successCount, total),
		Color3.fromRGB(100, 220, 120)
	)

	task.delay(4, function()
		if StatusLabel.Text:find("Completed") then
			setStatus("Ready • drag title bar to move", Color3.fromRGB(170,170,190))
		end
	end)

	enableUI()
end)

-- Initial status
setStatus("Ready • drag title bar to move")
